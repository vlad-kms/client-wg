___
## 1. Описание: ##
Скрипт устанавливает Wireguard Server и помогает управлять клиентами, создает нового, удаляет, показывает список всех клиентов в текущей конфигурации сервера.\
Работает только Debian, Ubuntu, Alpine

#### Алгоритм установки:
1) wg-mgr.sh prepare -c config.conf -f args.conf -i wg0 --ip4 10.18.18.1/24
   Подготовим файлы с данными для инсталляции, его затем можно подредактировать
2) wg-mgr install -c config.conf\
3) wg-mrg.sh client -a new -c config.conf -n client001 --ip4 10.18.18.2/24

Установит сервер WG с внутренним интерфейсом wg0, адресом 10.18.18.1/24. Создаст ключи для сервера, сохранит их в файле для дальнейшего использования. Создаст файлы конфигурации и QRcode для клиента с именем client001 и ip адресом 10.18.18.2/24.

Если файл config.conf не существует, или в нем нет какой-то переменной INST_* (см. описание в **3. prepare**) и значение для нее не передано в соответствующем аргументе командной строки, то это значение будет запрошено интерактивно при выполнении команды *install*. Это касается внешнего сетевого интерфейса, ip адреса для него, внутреннего сетевого интерфейса, его адресов ipv4 и ipv6, порта UDP на котором WG сервер принимает подключения, списка DNS серверов для клиентов и разрешенных IP адресов на сервере.

Опции и описание см.:\
общие в разделе **2. Использование**\
по командам в соответствующих разделах **n. ИмяКоманды**

___
## 2. Использование: ##

**wg-mgr.sh [command] [options]**

**command** - одна из списка ***[ install, uninstall, prepare, client ]***, 
по-умолчанию ***install***:

##### Команды: #####

    TODO НЕ РЕАЛИЗОВАНО uninstall  - удаление пакета wireguard и других, установленных вместе с ним,
                 а также удалить все созданные каталоги и файлы
    install    - установка пакета wireguard и других, требующихся для работы (iptables, qrencode и др.)
    prepare    - подготовить файл с данными для инсталляции
    client     - работа с клиентами: добавить, удалить, получить список

#### Опции общие: ####

***-h, --help*** - вывод справочной информации\
***&ensp;&ensp;&ensp;--debug*** - вывод справочной информации\
***-6, --use-ipv6*** - использовать IPv6 или нет для настройки локальных адресов WgSrv\
***&ensp;&ensp;&ensp;--dry-run*** - команду не выполнять, только показать\
***-w, --wg-path*** *\<pathWG\>* - путь к установленному Wireguard. По-умолчанию: **"/etc/wireguard"**. Позволяет поменять каталог, куда будут создаваться файлы --params при работе скрипта \
***-p, --params*** *\<filename\>* - созданный при install файл с уточненными данными используется для создания файлов клиента. По-умолчанию **"pathWG/params.conf"**\
***-d, --hand-params*** *\<filename\>* - созданный при install файл с расширенными данными для работы сценария настройки iptables. По-умолчанию **"pathWG/hand_params.conf"**


___
## 3. prepare ##
1. Готовит файл с параметрами инициализации, имя файла задается в командной строке с помощью аргумента -c (--config). По-умолчанию: **./vars4install.conf**.\
Например:

        INST_SERVER_PUB_NIC=ens3
        INST_SERVER_PUB_IP=192.168.15.41
        INST_SERVER_WG_NIC=wg1
        INST_SERVER_WG_IPV4=172.16.7.8/30
        INST_SERVER_WG_IPV6=fc00:66:66:66:\:1/64
        INST_SERVER_PORT=50672
        INST_SERVER_PRIV_KEY=PrivateKey WgSrv
        INST_SERVER_PUB_KEY=PublicKey WgSrv
        INST_CLIENT_DNS=1.1.1.1,1.0.0.1
        INST_ALLOWED_IPS=0.0.0.0/0,::/0

    **INST_SERVER_PUB_NIC** - сетевой интерфейс, на котором WireguardServer (WgSrv) принимает входящие пакеты для подключения клиентов. Определяется автоматически с помощью команды ip, но в файле можно поправить на нужный\
    **INST_SERVER_PUB_IP**  - IP адрес интерфейса INST_SERVER_PUB_NIC. Определяется автоматически с помощью команды ip, но в файле можно поправить на нужный\
    **INST_SERVER_PORT**    - Порт UDP на котором WgSrv слушает запросы от клиентов. Определяется атоматически случайным образом в диапазоне **49152-65535**\
    **INST_SERVER_WG_NIC**    - имя внутреннего сетевого интерфейса WgSrv. По-умолчанию: **wg0** (в скрипте из **$DEF_SERVER_WG_NIC**)\
    **INST_SERVER_WG_IPV4** - IPv4 внутреннего интерфейса. По-умолчанию: **10.66.66.1/24** (в скрипте из **$DEF_SERVER_WG_IPV4/$DEF_SERVER_WG_IPV4_MAS**)\
    **INST_SERVER_WG_IPV6** - IPv4 внутреннего интерфейса. По-умолчанию: **fc00:66:66:66::1/64** (в скрипте **$DEF_SERVER_WG_IPV6/$DEF_SERVER_WG_IPV6_MAS**)\
    **INST_SERVER_PRIV_KEY**- приватный ключ сервера WgSrv\
    **INST_SERVER_PUB_KEY** - публичный ключ сервера WgSrv\
    **INST_CLIENT_DNS**     - список DNS для клиентов, разделитель серверов ','. По-умолчанию: **1.1.1.1,1.0.0.1** (в скрипте из **$DEF_CLIENT_DNS**)\
    **INST_ALLOWED_IPS**    - список разрешенных IP адресов на внутреннем интефейсе WgSrv, разделитель адресов ','. По-умолчанию: **0.0.0.0/0,::/0** (в скрипте из **$DEF_ALLOWED_IPS**)

2. Готовит файл с сохраненными аргументами командной строки, имя задается значением аргумента **-f (--file-args)**. По-умолчанию: **./last-args**. Сохраняются некоторые параметры, чтобы при следующих запусках не вспоминать их значение каждый раз\
Например:

        path_wg=/etc/wireguard
        file_params=/etc/wireguard/params.conf
        file_hand_params=/etc/wireguard/hand_params.conf
        path_out=/etc/wireguard/.clients
        file_rules_firewall=./iptables/default-iptables.rules

    ***path_wg*** - путь где установлен Wireguard и храняться все его настройки. Соответствующий аргумент ***-w (--wg-path)***\
    ***file_params*** - имя файла с параметрами, которые получаются обработкой при инсталляции из файла --config и служит для настройки клиентов. Соответствующий аргумент ***-p (--params)***\
    ***file_hand_params*** - имя файла с дополнительными параметрами. Он подключается в файле-сценарии с настройками iptables. Соответствующий аргумент ***-d (--hand-params)***\
    ***path_out*** - путь, где сохраняются файлы с настройками клиентов. Соответствующий аргумент ***-o (--out-path)***\
    ***file_rules_firewall*** - имя файла-шаблона для сценария настройки iptables. Соответствующий аргумент ***-r (--rules-iptables)***\
 

#### Опции: ####
Используются для передачи значений в файл инициализации --config\
***-c, --config*** *\<NameFile\>* - имя файла с параметрами инициализации\
***-f, --file-args*** *\<NameFile\>* - имя файла где хранятся аргументы для командной строки"\
***-i, --wg-nic*** *\<IFACE\>* - имя внутреннего сетевого интерфейса, задает значение для **INST_SERVER_WG_NIC** в файле\
***--ip4*** *\<ipv4 address\>* - IPv4 адрес внутреннего сетевого интерфейса, задает значение для **INST_SERVER_WG_IPV4**\
***--ip6*** *\<ipv6 address\>* - IPv6 адрес внутреннего сетевого интерфейса, задает значение для **INST_SERVER_WG_IPV6**\
***--dns*** *\<list dns\>* - список DNS серверов, задает значение для **INST_CLIENT_DNS**\
***-e, --allowed-ips*** *\<list address\>* - список разрешенных адресов для сервераDNS серверов, задает значение для **INST_ALLOWED_IPS**\

#### Примеры: ####

*создаст файлы 'c2.conf' и 'last-args'*\
```
./wg-mgr.sh prepare -c c2.conf --ip4 1.1.1.1/24 --ip6 fd00::1/116 -i wg3 --dns 192.168.15.13,2.2.2.2 -e 0.0.0.0/1
```
*создаст файлы 'c2.conf' и 'saved.conf'*\
```
./wg-mgr.sh prepare -c c2.conf --ip4 1.1.1.1/24 --ip6 fd00::1/116 -i wg3 -e 0.0.0.0/1 -f saved.conf
```

___
## 4. install ##

Установка пакета wireguard и других, требующихся для работы (iptables, qrencode и др.)

#### Опции: ####
Используются для передачи значений в файл инициализации --config\
***-c, --config*** *\<NameFile\>* - имя файла с параметрами инициализации, где хранятся переменные ___INST_*___

        пример файла:
        INST_SERVER_PUB_NIC=ens3
        INST_SERVER_PUB_IP=192.168.15.41
        INST_SERVER_WG_NIC=wg1
        INST_SERVER_WG_IPV4=172.16.7.8/30
        INST_SERVER_WG_IPV6=fc00:66:66:66:\:1/64
        INST_SERVER_PORT=50672
        INST_SERVER_PRIV_KEY=PrivateKey WgSrv
        INST_SERVER_PUB_KEY=PublicKey WgSrv
        INST_CLIENT_DNS=1.1.1.1,1.0.0.1
        INST_ALLOWED_IPS=0.0.0.0/0,::/0

Если какая-то переменная не определена и не задана соответсвующим аргументом командной строки, то будет запрошено ее значение интерактивно.

***-f, --file-args*** *\<NameFile\>* - имя файла где хранятся аргументы для командной строки. Он создается при выполнении ***prepare*** или при выполнении ***install*** и обновляется при использоывании ключа ***-u (--update-args)***

        пример:
        path_wg=/etc/wireguard
        file_params=/etc/wireguard/params.conf
        file_hand_params=/etc/wireguard/hand_params.conf
        path_out=/etc/wireguard/.clients
        file_rules_firewall=./iptables/default-iptables.rules

***-d, --hand-params*** <filename> - файл для определения дополнительных переменных.

***-i, --wg-nic*** *\<IFACE\>* - имя внутреннего сетевого интерфейса, переопределяет значение **INST_SERVER_WG_NIC** из файла ***--config*** для сервера WG

***--ip4*** *\<ipv4 address\>* - IPv4 адрес внутреннего сетевого интерфейса, переопределяет значение **INST_SERVER_WG_IPV4** из файла ***--config*** для сервера WG

***--ip6*** *\<ipv6 address\>* - IPv6 адрес внутреннего сетевого интерфейса, переопределяет значение **INST_SERVER_WG_IPV6** из файла ***--config*** для сервера WG

***--dns*** *\<list dns\>* - список DNS серверов, переопределяет значение **INST_CLIENT_DNS** из файла ***--config*** для сервера WG

***-e (--allowed-ips)*** *\<list address\>* - список разрешенных адресов для сервераDNS серверов, переопределяет значение **INST_ALLOWED_IPS** из файла ***--config*** для сервера WG

***-u, --update-args*** - флаг, что надо обновить файл с аргументами ***--file_args*** соответственно текущим аргументам командной строки

***-r, --rules-iptables*** <filename>- имя файла-шаблона с правилами iptables (ip6tables). По-умолчанию: ***./iptables/default-iptables.rules***

***-p, --params*** <filename> - имя файл с уточненными данными после инсталяции. Этот файл создается в процессе выполнения данной команды используется при выполнении команды ***client***

____
## 5. client ##

Работа с склиентами в файле конфигурации Wireguard Server.
Поддерживаемые клиенты - это те которые обрамлены строками

\### Client NAMECLIENT DESC\
...\
...\
\### END Client NAMECLIENT DESC\

Если ***--action del***, то удаляются все строки между ними и они сами

#### Опции: ####
***-n, --name*** <name client> - имя клиента

***-a, --action*** <action> - указывает что делать: создать клиента, удалить клиента или получить список клиентов, значение должно быть из ACTION_CLIENT (add, del, list):\
***&nbsp;&nbsp;&nbsp;&nbsp;a | add | new   :***  создать файлы настроек для клиента на сервере и клиенте, файл QRcode для клиента\
***&nbsp;&nbsp;&nbsp;&nbsp;d | del | delete:***  удалить клиента из файла настроек сервера\
***&nbsp;&nbsp;&nbsp;&nbsp;l | list        :***  получить список клиентов из файла настроек сервера

***-p, --params*** <filename> - созданный при install файл с уточненными данными

***-d, --hand-params*** <filename> - файл с дополнительными переменными для настройки клиентов

***-i, --wg-nic*** <nic_name> - имя интерфейса сервера для подключения клиента. По этому значению определяется файл конфигурации.

***--ip4*** <address/mask> - IPv4 (ip/mask) клиента

***--ip6*** <address/mask> - IPv6 (ip/mask) клиента

***-e, --allowed-ips*** <network> - список ip адресов, которым разрешен доступ в формате 1.1.1.0/24,fdoo::0/64,2.2.2.2/32. По-умолчанию только адрес клиента в формате 1.1.1.0/32,fdoo::0/64,2.2.2.2/128

***--dns*** <dns1,dns2> - список ip адресов DNS серверов для клиента

***--all*** - вывести при ***--action list*** всех клиентов

#### Примеры: ####
вывести поддерживаемых клиентов для iface wg3
```
./wg-mgr.sh client -a l -i wg3
```
вывести клиентf для iface wg3 с именем CLIENT1, если такой есть
```
./wg-mgr.sh client -a list -i wg3 -n CLIENT1
```
вывести всех, не только поддерживаемых, клиентов для iface wg0
```
./wg-mgr.sh client -a l -i wg0 --all
```
добавить клиента с миенем CLN1 для iface wg3 --ipv4 10.18.18.2/24
```
./wg-mgr.sh client -a new -i wg3 --ip4 10.18.18.2/24
```
добавить клиента с миенем CLN2 для iface wg3 ipv4 10.18.18.2/24 и с ipv6 fd01:dd00::2/64
```
./wg-mgr.sh client -a new -i wg3 --ip4 10.18.18.2/24 --use-ipv6 --ip6 fd01:dd00::2/64
```
добавить клиента с миенем CLN2 для iface wg3 ipv4 10.18.18.2/24 и с ipv6 fd01:dd00::2/64, настройки сервера взять из файла ~/test-wg/wg3.conf, файл параметров инсталляции ~/test-wg/par.conf
```
./wg-mgr.sh client -a new -i wg3 --ip4 10.18.18.2/24 --use-ipv6 --ip6 fd01:dd00::2/64 -w ~/test-wg -p par.conf
```



____
____

